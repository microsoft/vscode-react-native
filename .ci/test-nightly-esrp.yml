trigger: none
pr: none
resources:
    repositories:
        - repository: 1ESPipelineTemplates
          type: git
          name: 1ESPipelineTemplates/1ESPipelineTemplates
          ref: refs/tags/release
extends:
    template: v1/1ES.Official.PipelineTemplate.yml@1ESPipelineTemplates
    parameters:
        pool:
            name: VSWebDiag1ESPipelinePool
            image: VSWebDiag_1ESImage_Windows
            os: windows
        customBuildTags:
            - ES365AIMigrationTooling
        stages:
            - stage: stage
              jobs:
                  - job: nightly_release
                    displayName: Nightly Release
                    templateContext:
                        outputs:
                            - output: pipelineArtifact
                              displayName: "Publish artifacts: Nightly Extension"
                              targetPath: "$(Build.ArtifactStagingDirectory)"
                              artifactName: "Extension (nightly)"
                    steps:
                        - template: /.ci/common-validation.yml@self
                        - task: Gulp@0
                          displayName: gulp release
                          inputs:
                              targets: release
                              arguments: --nightly
                        # - bash: |
                        #     VSIX=`ls *.vsix`
                        #     vsce publish --pat $(extension-publish-vswdbot-PAT) --packagePath $VSIX
                        #   displayName: "VSCE publish"
                        #   condition: and(succeeded(), eq(variables['dryrun'], 'false'))
                        - script: |
                              npx @vscode/vsce generate-manifest -i extension.vsix -o extension.manifest
                          displayName: Create VSIX Manifest
                        - script: |
                              cp extension.manifest extension.signature.p7s
                          displayName: Prepare Manifest Signature
                        - task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@5
                          inputs:
                              ConnectedServiceName: $(ConnectedServiceName)
                              UseMSIAuthentication: true
                              AppRegistrationClientId: $(AppRegistrationClientId)
                              AppRegistrationTenantId: $(AppRegistrationTenantId)
                              EsrpClientId: $(EsrpClientId)
                              AuthAKVName: $(AuthAKVName)
                              AuthSignCertName: $(AuthSignCertName)
                              FolderPath: "$(Build.SourcesDirectory)"
                              Pattern: "extension.signature.p7s"
                              signConfigType: inlineSignParams
                              inlineOperation: |
                                  [
                                    {
                                      "keyCode": "CP-401405",
                                      "operationSetCode": "VSCodePublisherSign",
                                      "parameters" : [],
                                      "toolName": "sign",
                                     "toolVersion": "1.0"
                                    }
                                  ]
                              SessionTimeout: 90
                              MaxConcurrency: 25
                              MaxRetryAttempts: 5
                              PendingAnalysisWaitTimeoutMinutes: 5
                              displayName: Sign Extension
                        - task: CopyFiles@2
                          displayName: "Copy Files to: $(Build.ArtifactStagingDirectory)"
                          inputs:
                              Contents: |
                                  *.vsix
                                  extension.signature.p7s
                                  extension.manifest
                              TargetFolder: "$(Build.ArtifactStagingDirectory)"
                        - pwsh: npx @vscode/vsce@latest publish -i $(Build.ArtifactStagingDirectory)/extension.vsix --manifestPath $(Build.ArtifactStagingDirectory)/extension.manifest --signaturePath $(Build.ArtifactStagingDirectory)/extension.signature.p7s
                          displayName: 'Publish extension'
                          workingDirectory: samples/extension-signing
