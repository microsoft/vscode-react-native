steps:
  - task: CmdLine@2
    displayName: "gulp release: windows"
    condition: eq(variables['Agent.OS'], 'Windows_NT')
    inputs:
      script: "gulp release --nightly --no-yarn"
  - bash: gulp release --nightly --no-yarn
    displayName: "gulp release: linux, macos"
    condition: or(eq(variables['Agent.OS'], 'Linux'), eq(variables['Agent.OS'], 'Darwin'))
    inputs:
      script: "gulp release --nightly --no-yarn"
  - task: CopyFiles@2
    displayName: "Copy Files to: $(Build.ArtifactStagingDirectory)"
    inputs:
      Contents: |
        $(System.DefaultWorkingDirectory)/*.vsix
      TargetFolder: "$(System.DefaultWorkingDirectory)/test/smoke/resources/extension"
  - bash: npm run prepare-smoke-tests
    displayName: "Prepare smoke tests"
  - bash: npm run smoke-tests --verbose
    displayName: "Run smoke tests"
    env:
      DISPLAY: ":99.0"
  - task: PublishBuildArtifacts@1
    displayName: "Publish screenshots"
    inputs:
      PathtoPublish: "$(System.DefaultWorkingDirectory)/test/smoke/screenshots"
      ArtifactName: 'smoke-test-screenshots'
      publishLocation: 'Container'
